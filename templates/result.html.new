<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hasil Prediksi BMI - Health Monitor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Import file charts.js -->
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <style>
      :root {
        --primary-color: #4facfe;
        --secondary-color: #00f2fe;
        --accent-color: #0062cc;
        --dark-color: #333;
        --light-color: #f8f9fa;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        min-height: 100vh;
        padding: 30px 0;
      }
      .container {
        max-width: 1100px;
        background-color: #fff;
        padding: 35px;
        border-radius: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        color: var(--dark-color);
        margin-bottom: 30px;
        animation: fadeIn 0.6s ease-in-out;
      }
      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .container h1 {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 20px;
        font-weight: 700;
        font-size: 2.5rem;
      }
      .result-header {
        background-color: rgba(79, 172, 254, 0.05);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        border-left: 5px solid var(--primary-color);
      }
      .result-header::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 150px;
        height: 150px;
        background: linear-gradient(
          135deg,
          rgba(79, 172, 254, 0.1),
          rgba(0, 242, 254, 0.1)
        );
        border-radius: 50%;
        transform: translate(50%, -50%);
        z-index: 1;
      }
      .result-header h2 {
        font-size: 2rem;
        margin-bottom: 15px;
        font-weight: 600;
        color: var(--primary-color);
      }
      .result-date {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
      }
      .result-section {
        background-color: #fff;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border: 1px solid #f1f1f1;
      }
      .result-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .result-section h4 {
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f1f1f1;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      .result-section h4 i {
        margin-right: 10px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border-radius: 50%;
        font-size: 14px;
      }
      .btn-primary {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        border: none;
        padding: 14px 30px;
        font-size: 1.1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-weight: 500;
      }
      .btn-primary:hover {
        background: linear-gradient(
          to right,
          var(--secondary-color),
          var(--primary-color)
        );
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        transform: translateY(-3px);
      }
      .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 12px 25px;
        font-size: 1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-weight: 500;
        background: transparent;
      }
      .btn-outline-primary:hover {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border-color: transparent;
      }
      .bmi-gauge {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f1f1f1;
        border-radius: 10px;
        margin: 25px 0;
        overflow: hidden;
      }
      .bmi-range {
        position: absolute;
        height: 100%;
        transition: all 0.5s ease;
      }
      .bmi-marker {
        position: absolute;
        width: 4px;
        height: 30px;
        background-color: #333;
        top: -5px;
        transform: translateX(-50%);
        z-index: 10;
      }
      .bmi-value {
        position: absolute;
        bottom: -30px;
        transform: translateX(-50%);
        text-align: center;
        font-weight: bold;
        font-size: 1rem;
      }
      .bmi-category {
        display: inline-block;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 8px 20px;
        border-radius: 20px;
        margin-top: 15px;
      }
      .bmi-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
        font-size: 0.85rem;
        color: #666;
      }
      .stat-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        border: 1px solid #f1f1f1;
        height: 100%;
        transition: all 0.3s ease;
      }
      .stat-card:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
      }
      .stat-card-title {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
      }
      .stat-card-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 5px;
      }
      .stat-card-desc {
        font-size: 0.85rem;
        color: #666;
      }
      .recommendation-item {
        margin-bottom: 15px;
        padding-left: 25px;
        position: relative;
      }
      .recommendation-item::before {
        content: "\f00c";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        left: 0;
        top: 0;
        color: var(--success-color);
      }
      .badge-custom {
        padding: 8px 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border-radius: 8px;
      }
      .badge-good {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
      }
      .badge-warning {
        background-color: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
      }
      .badge-danger {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
      }
      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
      }
      .footer {
        text-align: center;
        color: white;
        margin-top: 20px;
        font-size: 0.9rem;
      }
      .footer a {
        color: white;
        text-decoration: none;
        font-weight: 500;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      .info-tooltip {
        cursor: pointer;
        color: var(--primary-color);
        margin-left: 5px;
      }
      .nav-pills .nav-link {
        padding: 10px 20px;
        border-radius: 10px;
        color: #666;
        font-weight: 500;
        margin-right: 10px;
        transition: all 0.3s ease;
      }
      .nav-pills .nav-link.active {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
      }
      @media print {
        body {
          background: white;
        }
        .container {
          box-shadow: none;
          max-width: 100%;
        }
        .no-print {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="result-header">
        <p class="result-date">
          <i class="fas fa-calendar-alt me-2"></i> {{ current_date }}
        </p>
        <h1><i class="fas fa-chart-bar"></i> Hasil Prediksi BMI</h1>
        <div class="row align-items-center">
          <div class="col-md-6">
            <h2>{{ prediction }}</h2>
            {% if bmi_category == "Underweight" %}
            <span class="bmi-category bg-primary bg-opacity-10 text-primary">
              <i class="fas fa-weight me-2"></i> Underweight
            </span>
            {% elif bmi_category == "Normal" %}
            <span class="bmi-category bg-success bg-opacity-10 text-success">
              <i class="fas fa-check-circle me-2"></i> Normal
            </span>
            {% elif bmi_category == "Overweight" %}
            <span class="bmi-category bg-warning bg-opacity-10 text-warning">
              <i class="fas fa-exclamation-circle me-2"></i> Overweight
            </span>
            {% else %}
            <span class="bmi-category bg-danger bg-opacity-10 text-danger">
              <i class="fas fa-exclamation-triangle me-2"></i> Obese
            </span>
            {% endif %}
          </div>
          <div class="col-md-6">
            <div class="text-end no-print">
              <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="fas fa-print me-2"></i> Cetak Hasil
              </button>
            </div>
          </div>
        </div>

        <!-- BMI Gauge -->
        <div class="bmi-gauge mt-4">
          <div
            class="bmi-range"
            style="
              width: 100%;
              background: linear-gradient(
                to right,
                #3498db,
                #2ecc71,
                #f39c12,
                #e74c3c
              );
            "
          ></div>
          <div class="bmi-marker" id="bmiMarker"></div>
          <div class="bmi-value" id="bmiValue"></div>
        </div>
        <div class="bmi-labels">
          <span>Underweight (&lt;18.5)</span>
          <span>Normal (18.5-24.9)</span>
          <span>Overweight (25-29.9)</span>
          <span>Obese (&gt;30)</span>
        </div>
      </div>

      <!-- Nav Tabs -->
      <ul class="nav nav-pills mb-4 no-print" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="overview-tab"
            data-bs-toggle="pill"
            data-bs-target="#overview"
            type="button"
            role="tab"
            aria-controls="overview"
            aria-selected="true"
          >
            <i class="fas fa-th-large me-2"></i> Ringkasan
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="recommendations-tab"
            data-bs-toggle="pill"
            data-bs-target="#recommendations"
            type="button"
            role="tab"
            aria-controls="recommendations"
            aria-selected="false"
          >
            <i class="fas fa-list-ul me-2"></i> Rekomendasi
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="charts-tab"
            data-bs-toggle="pill"
            data-bs-target="#charts"
            type="button"
            role="tab"
            aria-controls="charts"
            aria-selected="false"
          >
            <i class="fas fa-chart-line me-2"></i> Grafik Detail
          </button>
        </li>
      </ul>

      <div class="tab-content" id="resultTabsContent">
        <!-- Tab Ringkasan -->
        <div
          class="tab-pane fade show active"
          id="overview"
          role="tabpanel"
          aria-labelledby="overview-tab"
        >
          <div class="row">
            <div class="col-md-4">
              <div class="stat-card">
                <div class="stat-card-title">Kebutuhan Kalori Harian</div>
                <div class="stat-card-value">
                  {{ additional_stats.daily_calories_need|int }} kcal
                </div>
                <div class="stat-card-desc">
                  Berdasarkan tingkat aktivitas Anda
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card">
                <div class="stat-card-title">Efisiensi Latihan</div>
                <div class="stat-card-value">
                  {{ additional_stats.calories_burned_per_hour|int }} kcal/jam
                </div>
                <div class="stat-card-desc">
                  Kalori yang terbakar per jam latihan
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card">
                <div class="stat-card-title">Target Detak Jantung</div>
                <div class="stat-card-value">
                  {{ health_insights.target_hr_zone }}
                </div>
                <div class="stat-card-desc">
                  Zona optimal untuk latihan efektif
                </div>
              </div>
            </div>
          </div>

          <div class="result-section">
            <h4><i class="fas fa-heartbeat"></i> Insight Kesehatan</h4>
            <div class="row">
              <div class="col-md-6">
                <ul class="list-group list-group-flush">
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Status Detak Jantung
                    <span
                      class="badge badge-custom {{ 'badge-good' if health_insights.heart_rate_status == 'Normal' else 'badge-warning' }}"
                    >
                      {{ health_insights.heart_rate_status }}
                    </span>
                  </li>
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Status Hidrasi
                    <span
                      class="badge badge-custom {{ 'badge-good' if health_insights.hydration_status == 'Baik' else 'badge-warning' }}"
                    >
                      {{ health_insights.hydration_status }}
                    </span>
                  </li>
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Konsistensi Latihan
                    <span
                      class="badge badge-custom {{ 'badge-good' if health_insights.workout_consistency == 'Baik' else 'badge-warning' }}"
                    >
                      {{ health_insights.workout_consistency }}
                    </span>
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul class="list-group list-group-flush">
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Efisiensi Latihan
                    <span
                      class="badge badge-custom {{ 'badge-good' if 'Tinggi' in health_insights.workout_efficiency else 'badge-warning' if 'Sedang' in health_insights.workout_efficiency else 'badge-danger' }}"
                    >
                      {{ health_insights.workout_efficiency }}
                    </span>
                  </li>
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Kapasitas Pemulihan
                    <span
                      class="badge badge-custom {{ 'badge-good' if 'Baik' in health_insights.recovery_assessment or 'Sangat Baik' in health_insights.recovery_assessment else 'badge-warning' }}"
                    >
                      {{ health_insights.recovery_assessment }}
                    </span>
                  </li>
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                  >
                    Status Persentase Lemak
                    <span
                      class="badge badge-custom {{ 'badge-good' if 'Ideal' in health_insights.fat_percentage_status else 'badge-warning' }}"
                    >
                      {{ health_insights.fat_percentage_status }}
                    </span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Rekomendasi -->
        <div
          class="tab-pane fade"
          id="recommendations"
          role="tabpanel"
          aria-labelledby="recommendations-tab"
        >
          <div class="row">
            <div class="col-md-6">
              <div class="result-section">
                <h4><i class="fas fa-weight"></i> Rekomendasi BMI</h4>
                <div class="recommendations-list">
                  {% for rec in bmi_recommendations %}
                  <div class="recommendation-item">{{ rec }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="result-section">
                <h4><i class="fas fa-dumbbell"></i> Rekomendasi Latihan</h4>
                <div class="recommendations-list">
                  {% for rec in workout_recommendations %}
                  <div class="recommendation-item">{{ rec }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="result-section">
            <h4><i class="fas fa-apple-alt"></i> Rekomendasi Nutrisi</h4>
            <div class="row">
              <div class="col-md-6">
                <h5 class="mb-3">Makronutrien yang Direkomendasikan</h5>
                <div class="chart-container" style="height: 200px">
                  <canvas id="macroChart"></canvas>
                </div>
                <div class="mt-3">
                  <p>
                    Berdasarkan kebutuhan kalori harian Anda sekitar
                    <strong
                      >{{ visualization_data.macronutrients.total }}
                      kcal</strong
                    >, berikut distribusi makronutrien yang direkomendasikan:
                  </p>
                  <ul>
                    <li>
                      <strong>Protein:</strong> {{
                      visualization_data.macronutrients.protein }} kcal ({{
                      visualization_data.macronutrients.protein_grams }} gram)
                    </li>
                    <li>
                      <strong>Karbohidrat:</strong> {{
                      visualization_data.macronutrients.carbs }} kcal ({{
                      visualization_data.macronutrients.carbs_grams }} gram)
                    </li>
                    <li>
                      <strong>Lemak:</strong> {{
                      visualization_data.macronutrients.fat }} kcal ({{
                      visualization_data.macronutrients.fat_grams }} gram)
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <h5 class="mb-3">Tips Nutrisi</h5>
                {% if bmi_category == "Underweight" %}
                <ul>
                  <li>Konsumsi makanan padat nutrisi dan tinggi kalori</li>
                  <li>
                    Tingkatkan asupan protein (daging tanpa lemak, telur,
                    kacang-kacangan)
                  </li>
                  <li>Konsumsi 5-6 porsi makan lebih kecil per hari</li>
                  <li>
                    Tambahkan sumber lemak sehat (alpukat, minyak zaitun,
                    kacang-kacangan)
                  </li>
                </ul>
                {% elif bmi_category == "Normal" %}
                <ul>
                  <li>Pertahankan asupan kalori seimbang</li>
                  <li>Prioritaskan makanan utuh dan minim proses</li>
                  <li>Jaga konsumsi protein untuk mempertahankan massa otot</li>
                  <li>Batasi gula dan makanan olahan</li>
                </ul>
                {% elif bmi_category == "Overweight" %}
                <ul>
                  <li>Kurangi asupan kalori sebesar 300-500 kcal per hari</li>
                  <li>Tingkatkan konsumsi sayur dan buah</li>
                  <li>Pilih karbohidrat kompleks (biji-bijian utuh, quinoa)</li>
                  <li>Batasi minuman manis dan alkohol</li>
                </ul>
                {% else %}
                <ul>
                  <li>
                    Konsultasi dengan ahli gizi untuk program penurunan berat
                    badan yang aman
                  </li>
                  <li>
                    Kurangi asupan kalori secara bertahap (500-750 kcal per
                    hari)
                  </li>
                  <li>Fokus pada makanan tinggi nutrisi dan rendah kalori</li>
                  <li>
                    Tingkatkan asupan serat untuk memberi rasa kenyang lebih
                    lama
                  </li>
                </ul>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Grafik Detail -->
        <div
          class="tab-pane fade"
          id="charts"
          role="tabpanel"
          aria-labelledby="charts-tab"
        >
          <div class="row">
            <div class="col-md-6">
              <div class="result-section">
                <h4><i class="fas fa-heartbeat"></i> Analisis Detak Jantung</h4>
                <div class="chart-container">
                  <canvas id="heartRateChart"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="result-section">
                <h4><i class="fas fa-fire"></i> Analisis Pembakaran Kalori</h4>
                <div class="chart-container">
                  <canvas id="caloriesChart"></canvas>
                </div>
                <div class="mt-3 small text-muted">
                  Berdasarkan data Anda, pembakaran kalori selama latihan adalah
                  {{ user_data.Calories_Burned }} kcal per sesi dengan efisiensi
                  {{ additional_stats.calories_burned_per_hour|int }} kcal/jam.
                </div>
              </div>
            </div>
          </div>

          <div class="result-section">
            <h4><i class="fas fa-user-check"></i> Gambaran Data Pribadi</h4>
            <div class="row">
              <div class="col-md-6">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <th>Usia</th>
                      <td>{{ user_data.Age }} tahun</td>
                    </tr>
                    <tr>
                      <th>Jenis Kelamin</th>
                      <td>
                        {% if user_data.Gender == 'Male' %}Laki-laki{% else
                        %}Perempuan{% endif %}
                      </td>
                    </tr>
                    <tr>
                      <th>Berat Badan</th>
                      <td>{{ user_data.Weight }} kg</td>
                    </tr>
                    <tr>
                      <th>Tinggi Badan</th>
                      <td>{{ user_data.Height }} m</td>
                    </tr>
                    <tr>
                      <th>Persentase Lemak</th>
                      <td>{{ user_data.Fat_Percentage }}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <th>Jenis Latihan</th>
                      <td>{{ user_data.Workout_Type }}</td>
                    </tr>
                    <tr>
                      <th>Level Pengalaman</th>
                      <td>{{ user_data.Experience_Level }}</td>
                    </tr>
                    <tr>
                      <th>Frekuensi Latihan</th>
                      <td>{{ user_data.Workout_Frequency }} hari/minggu</td>
                    </tr>
                    <tr>
                      <th>Durasi Sesi</th>
                      <td>{{ user_data.Session_Duration }} jam</td>
                    </tr>
                    <tr>
                      <th>Konsumsi Air</th>
                      <td>{{ user_data.Water_Intake }} liter/hari</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center mt-4 no-print">
        <a href="{{ url_for('home') }}" class="btn btn-primary">
          <i class="fas fa-arrow-left me-2"></i> Kembali ke Halaman Utama
        </a>
      </div>
    </div>

    <div class="footer no-print">
      <p>
        &copy; 2023 Health Monitor |
        <a href="{{ url_for('about') }}">Tentang Aplikasi</a>
      </p>
    </div>

    <!-- Menyembunyikan data visualisasi dalam data attributes -->
    <div
      id="visualization-data"
      style="display: none"
      data-bmi-value="{{ visualization_data.bmi.value }}"
      data-bmi-min="{{ visualization_data.bmi.min }}"
      data-bmi-max="{{ visualization_data.bmi.max }}"
      data-bmi-ranges="{{ visualization_data.bmi.ranges|tojson }}"
      data-resting-bpm="{{ visualization_data.heart_rate.resting }}"
      data-avg-bpm="{{ visualization_data.heart_rate.average }}"
      data-max-bpm="{{ visualization_data.heart_rate.max }}"
      data-target-hr-min="{{ visualization_data.heart_rate.target_min }}"
      data-target-hr-max="{{ visualization_data.heart_rate.target_max }}"
      data-calories-burned="{{ user_data.Calories_Burned }}"
      data-daily-calories="{{ visualization_data.daily_calories }}"
      data-workout-efficiency="{{ visualization_data.workout_efficiency }}"
      data-user-weight="{{ user_data.Weight }}"
      data-user-height="{{ user_data.Height }}"
    ></div>

    <!-- Inisialisasi data dari elemen HTML -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Ambil data dari elemen tersembunyi
        const dataElement = document.getElementById("visualization-data");

        // Buat objek visualizationData
        const visualizationData = {
          bmi: {
            value: parseFloat(dataElement.dataset.bmiValue || "0"),
            min: parseFloat(dataElement.dataset.bmiMin || "15"),
            max: parseFloat(dataElement.dataset.bmiMax || "40"),
            ranges: JSON.parse(dataElement.dataset.bmiRanges || "[]"),
          },
          heart_rate: {
            resting: parseFloat(dataElement.dataset.restingBpm || "0"),
            average: parseFloat(dataElement.dataset.avgBpm || "0"),
            max: parseFloat(dataElement.dataset.maxBpm || "0"),
            target_min: parseFloat(dataElement.dataset.targetHrMin || "0"),
            target_max: parseFloat(dataElement.dataset.targetHrMax || "0"),
          },
          calories: {
            burned: parseFloat(dataElement.dataset.caloriesBurned || "0"),
            daily_need: parseFloat(dataElement.dataset.dailyCalories || "0"),
            efficiency: parseFloat(
              dataElement.dataset.workoutEfficiency || "0"
            ),
          },
        };

        console.log("Data visualisasi:", visualizationData);

        // Visualisasi BMI Marker
        const bmiValue = visualizationData.bmi.value;
        const bmiRanges = visualizationData.bmi.ranges;
        const bmiGaugeWidth = document.querySelector(".bmi-gauge").offsetWidth;
        const bmiMarker = document.getElementById("bmiMarker");
        const bmiValueEl = document.getElementById("bmiValue");

        // Set position berdasarkan nilai BMI
        const minBMI = visualizationData.bmi.min;
        const maxBMI = visualizationData.bmi.max;
        const bmiPercent = Math.min(
          100,
          Math.max(0, ((bmiValue - minBMI) / (maxBMI - minBMI)) * 100)
        );
        const markerPosition = (bmiPercent / 100) * bmiGaugeWidth;

        bmiMarker.style.left = markerPosition + "px";
        bmiValueEl.style.left = markerPosition + "px";
        bmiValueEl.innerText = bmiValue.toFixed(1);

        // Inisialisasi chart pada tab "Rekomendasi"
        document
          .getElementById("recommendations-tab")
          .addEventListener("shown.bs.tab", function (e) {
            console.log("Recommendations tab activated");
            // Buat macro chart ketika tab rekomendasi aktif
            createMacroChart();
          });

        // Inisialisasi chart pada tab "Grafik Detail"
        document
          .getElementById("charts-tab")
          .addEventListener("shown.bs.tab", function (e) {
            console.log("Charts tab activated");
            // Buat semua chart ketika tab grafik detail aktif
            createHeartRateChart();
            createCaloriesChart();
          });

        // Buat chart pada tab yang aktif saat halaman dimuat
        const activeTab = document.querySelector(".tab-pane.active");
        if (activeTab) {
          const tabId = activeTab.id;
          console.log("Active tab on load:", tabId);

          if (tabId === "recommendations") {
            createMacroChart();
          } else if (tabId === "charts") {
            createHeartRateChart();
            createCaloriesChart();
          }
        }

        // Fungsi untuk membuat heart rate chart
        function createHeartRateChart() {
          const hrCanvas = document.getElementById("heartRateChart");
          if (!hrCanvas) {
            console.error("Heart rate chart canvas tidak ditemukan");
            return;
          }

          // Hapus instance chart yang mungkin sudah ada sebelumnya
          if (window.heartRateChart) {
            window.heartRateChart.destroy();
          }

          console.log(
            "Membuat heart rate chart dengan data:",
            visualizationData.heart_rate
          );

          window.heartRateChart = new Chart(hrCanvas, {
            type: "bar",
            data: {
              labels: [
                "Istirahat",
                "Rata-rata",
                "Maksimum",
                "Target Min",
                "Target Max",
              ],
              datasets: [
                {
                  label: "Detak Jantung (BPM)",
                  data: [
                    visualizationData.heart_rate.resting,
                    visualizationData.heart_rate.average,
                    visualizationData.heart_rate.max,
                    visualizationData.heart_rate.target_min,
                    visualizationData.heart_rate.target_max,
                  ],
                  backgroundColor: [
                    "rgba(75, 192, 192, 0.2)",
                    "rgba(54, 162, 235, 0.2)",
                    "rgba(255, 99, 132, 0.2)",
                    "rgba(255, 206, 86, 0.2)",
                    "rgba(255, 159, 64, 0.2)",
                  ],
                  borderColor: [
                    "rgba(75, 192, 192, 1)",
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 99, 132, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(255, 159, 64, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Detak Jantung (BPM)",
                  },
                },
              },
            },
          });
        }

        // Fungsi untuk membuat calories chart
        function createCaloriesChart() {
          const caloriesCanvas = document.getElementById("caloriesChart");
          if (!caloriesCanvas) {
            console.error("Calories chart canvas tidak ditemukan");
            return;
          }

          // Hapus instance chart yang mungkin sudah ada sebelumnya
          if (window.caloriesChart) {
            window.caloriesChart.destroy();
          }

          console.log(
            "Membuat calories chart dengan data:",
            visualizationData.calories
          );

          window.caloriesChart = new Chart(caloriesCanvas, {
            type: "doughnut",
            data: {
              labels: ["Kalori Terbakar", "Kebutuhan Harian"],
              datasets: [
                {
                  data: [
                    visualizationData.calories.burned,
                    visualizationData.calories.daily_need,
                  ],
                  backgroundColor: [
                    "rgba(255, 99, 132, 0.7)",
                    "rgba(54, 162, 235, 0.7)",
                  ],
                  borderColor: [
                    "rgba(255, 99, 132, 1)",
                    "rgba(54, 162, 235, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
                title: {
                  display: true,
                  text: "Perbandingan Kalori (kcal)",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.label || "";
                      let value = context.raw;
                      return `${label}: ${value} kcal`;
                    },
                  },
                },
              },
            },
          });
        }

        // Fungsi untuk membuat macro chart
        function createMacroChart() {
          const macroCanvas = document.getElementById("macroChart");
          if (!macroCanvas) {
            console.error("Macro chart canvas tidak ditemukan");
            return;
          }

          // Hapus instance chart yang mungkin sudah ada sebelumnya
          if (window.macroChart) {
            window.macroChart.destroy();
          }

          const dailyCalories = visualizationData.calories.daily_need;
          const proteinCals = dailyCalories * 0.25;
          const carbsCals = dailyCalories * 0.5;
          const fatCals = dailyCalories * 0.25;

          console.log(
            "Membuat macro chart dengan kalori harian:",
            dailyCalories
          );

          window.macroChart = new Chart(macroCanvas, {
            type: "pie",
            data: {
              labels: ["Protein (25%)", "Karbohidrat (50%)", "Lemak (25%)"],
              datasets: [
                {
                  data: [proteinCals, carbsCals, fatCals],
                  backgroundColor: [
                    "rgba(54, 162, 235, 0.7)",
                    "rgba(255, 206, 86, 0.7)",
                    "rgba(75, 192, 192, 0.7)",
                  ],
                  borderColor: [
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(75, 192, 192, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.label || "";
                      let value = context.raw;
                      let percent = ((value / dailyCalories) * 100).toFixed(1);

                      if (label.includes("Protein")) {
                        const grams = (value / 4).toFixed(0);
                        return `${label}: ${value.toFixed(0)} kcal (${grams}g)`;
                      } else if (label.includes("Karbohidrat")) {
                        const grams = (value / 4).toFixed(0);
                        return `${label}: ${value.toFixed(0)} kcal (${grams}g)`;
                      } else if (label.includes("Lemak")) {
                        const grams = (value / 9).toFixed(0);
                        return `${label}: ${value.toFixed(0)} kcal (${grams}g)`;
                      }

                      return `${label}: ${value.toFixed(0)} kcal (${percent}%)`;
                    },
                  },
                },
              },
            },
          });
        }
      });
    </script>
  </body>
</html>
